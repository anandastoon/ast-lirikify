/*
 ast-lirik.js
 http://saya.anandastoon.com
 MIT licensed

 Copyright (C) 2019 Ananda Maulana Ilhami (Anandastoon), http://anandastoon.com
*/
(function(x,g){"function"===typeof define&&define.amd?define(function(){x.AstLirik=g();return x.AstLirik}):"object"===typeof exports?module.exports=g():x.AstLirik=g()})(this,function(){function x(y,l){var A=Array.apply(0,Array(y)).map(function(p,z){return z}).filter(function(p){return p!=l}).sort(function(p,z){return.5<Math.random()});A.push(l);return A}var g=function(y,l){function A(a){b.playlist[f.i].duration=n.duration;f.i++;f.i<b.playlist.length?(p(),f.buffer=!1):f.c(f.i,b.playlist)}function p(){for(var a=
f.i;a<b.playlist.length;a++)if(-1==b.playlist[a].duration){f.buffer=!0;n.src=b.playlist[a].src;n.load();f.i=a;break}}function z(a,d){b.playlist.push({src:a,name:d,ogg:"",duration:-1,lyric:{is:!1,lyric:"",prop:{},next:"",index:0,changed:!0,offset:0}})}function E(){f.shuffleIdx=b.playlist.length-1;f.shuffleArr=x(b.playlist.length,b.current)}function M(){k.buffered=b.elAudio.buffered.end(0);k.pbuffered=k.buffered/b.elAudio.duration*100;k.buffered>=b.elAudio.duration&&clearInterval(F)}function H(){b.elAudio.src=
b.playlist[b.current].src;b.elAudio.load();b.elAudio.play();b.playlist[b.current].lyric.is&&(b.playlist[b.current].lyric.index=0)}l=void 0===l?{}:l;var b=this;this.elAudio=document.getElementById(y);for(var w in l)if(l.hasOwnProperty(w))switch(w){case "time":this.elAudio.currentTime=l[w];break;case "speed":this.elAudio.playbackRate=l[w];break;default:this.elAudio[w]=l[w]}this.context=window.webkitAudioContext?new webkitAudioContext:new AudioContext;var G,q,I,C,J=!1,K=!1;this.playlist=[];this.isShuffle=
!1;this.current=0;this.prop={time:this.elAudio.currentTime,volume:this.elAudio.volume,speed:this.elAudio.playbackRate,src:this.elAudio.src,loop:0,muted:this.elAudio.muted,duration:this.elAudio.duration};this.repeatState={NONE:0,ONE:1,ALL:2};var k={current:0,readable:"0",timewms:"0",bufferStart:0,bufferEnd:0,duration:0,buffered:0,pbuffered:0,percentage:0},h={waiting:!1,play:!1,pause:!0,end:!1,loop:!1},f={buffer:!1,i:0,recheck:!1,arr:0,c:function(){},shuffleArr:[],shuffleIdx:0},n=new Audio;null!=this.elAudio.src&&
""!=this.elAudio.src&&(this.elAudio.crossOrigin="anonymous",this.elAudio.name=this.elAudio.attributes.src.value.replace(/^.*\/|\.$/g,""),this.elAudio.load(),z(this.elAudio.src,this.elAudio.name),p());n.onloadedmetadata=A;var F=-1;this.elAudio.onseeking=function(){};this.elAudio.oncanplay=function(){J=!0;k.buffered=b.elAudio.buffered.end(0);k.pbuffered=k.buffered/b.elAudio.duration*100};this.elAudio.oncanplaythrough=function(){k.buffered=b.elAudio.buffered.end(0);k.pbuffered=k.buffered/b.elAudio.duration*
100};this.elAudio.onprogress=function(){J&&0>F&&(F=setInterval(M,100))};this.elAudio.onseeked=function(){if(0<b.playlist.length)var a=b.playlist[b.current].lyric;if(a.is)for(var d=0;d<a.prop.data.length;d++)if(b.elAudio.currentTime>a.prop.data[d].time)a.index=d-1;else break};this.elAudio.onplay=function(){G&&(C=new Uint8Array(q.frequencyBinCount));h.waiting=!1;h.play=!0;h.end=!1;h.pause=!1};this.elAudio.onwaiting=function(){h.waiting=!0};this.elAudio.onplaying=function(){h.waiting=!1;h.play=!0;h.end=
!1;h.pause=!1};this.elAudio.onended=function(){b.elAudio.currentTime=0;b.playlist[b.current].lyric.index=0;switch(b.prop.loop){case b.repeatState.NONE:h.end=!0;h.play=!1;break;case b.repeatState.ONE:h.loop=!0;b.elAudio.play();break;case b.repeatState.ALL:b.playNext(),h.loop=!0,b.elAudio.play()}};var r=function(a){var d=a;"time"==a&&(d="currentTime");"speed"==a&&(d="playbackRate");this.prop[a]=this.elAudio[d]},L=function(a){var d="ar al ti au id by length re ve offset".split(" "),e=!0,c=[];c="";var t=
!1;a=a.split("\n");var m=this.playlist[this.current].lyric;for(c=0;c<d.length;c++)m.prop[d[c]]="";for(var D=0;D<a.length;D++)if(e&&(c=a[D].trim().replace(/[\[\]]/g,"").split(/:/),-1==d.indexOf(c[0])?(m.prop.data=[],e=!1):(""!=c[0].trim()&&(m.prop[c[0]]=c[1]),"offset"==c[0]&&(m.offset=c[1]))),!e){c=a[D].trim();c=c.replace(/\]\s+\[/g,"][");for(var u=!0,B=[];u;)if("["==c.charAt(0))B.push(c.substring(1,c.indexOf("]"))),c=c.slice(c.indexOf("]")+1);else{1<B.length&&(t=!0);for(u=0;u<B.length;u++){var v=
B[u].split(/[:\.]/);v=60*parseInt(v[0])+parseInt(v[1])+parseInt(v[2])/100;isNaN(v)||(0==m.prop.data.length&&0<v&&m.prop.data.push({at:"00:00.00",lyric:"",time:0}),m.prop.data.push({at:B[u],lyric:c,time:v}))}u=!1}}t&&m.prop.data.sort(function(N,O){return N.time-O.time});0<m.prop.data.length&&(m.is=!0)};g.prototype.pAdd=function(a,d){d&&"[object Function]"==={}.toString.call(d)&&(f.c=d);for(var e=0;e<a.length;e++){if("object"===typeof a[e]){var c=(window.URL||window.webkitURL).createObjectURL(a[e]);
var t=a[e].name}else"string"===typeof a[e]&&(c=a[e],t=a[e].split("/").pop());z(c,t)}f.i=0;f.recheck=!0;n.onloadedmetadata=A;p()};g.prototype.pRemove=function(a){if(this.current==a)return 0;this.current>a&&(f.shuffleIdx--,this.current=f.shuffleIdx);this.isShuffle&&E();this.playlist.splice(a,1)};g.prototype.shuffle=function(a){(a=!!a)&&E();this.isShuffle=a};g.prototype.playNext=function(){1<b.playlist.length?(f.shuffleIdx++,f.shuffleIdx%=b.playlist.length,b.current=b.isShuffle?f.shuffleArr[f.shuffleIdx]:
f.shuffleIdx):(f.shuffleIdx=0,b.current=f.shuffleIdx);H()};g.prototype.playPrev=function(){if(3<b.elAudio.currentTime)return b.elAudio.currentTime=0;1<b.playlist.length?(f.shuffleIdx--,0>f.shuffleIdx&&(f.shuffleIdx=b.playlist.length-1),b.current=b.isShuffle?f.shuffleArr[f.shuffleIdx]:f.shuffleIdx):(f.shuffleIdx=0,b.current=f.shuffleIdx);H()};g.prototype.setLyric=function(a,d,e){d=void 0===d?0:d;var c=new FileReader;c.onload=function(t){L.call(b,t.target.result);e&&"[object Function]"==={}.toString.call(e)&&
e(b.playlist[b.current].lyric.prop);b.elAudio.play();b.update()};b.playlist[b.current].lyric.offset+=d;c.readAsText(a);return this};g.prototype.setLyricFromInternet=function(a,d){var e=new XMLHttpRequest;e.onreadystatechange=function(){4==e.readyState&&(200==e.status?(d(e.responseText),L.call(b,e.responseText)):d(null))};e.open("GET",a,!0);e.responseType="text";e.send()};g.prototype.update=function(a){function d(){var c={current:"",change:!1,prop:{}};0<b.playlist.length&&(c=b.playlist[b.current].lyric);
if(!b.elAudio.paused&&"undefined"!=typeof c.prop.data)for(;c.index+1<c.prop.data.length&&c.prop.data[c.index+1].time<b.elAudio.currentTime-parseFloat(c.offset)/1E3;)c.index++,c.current=c.prop.data[c.index].lyric,c.next="undefined"!=typeof c.prop.data[c.index+1]?c.prop.data[c.index+1].lyric:"",c.changed=!0;k.current=b.elAudio.currentTime;k.readable=("00"+Math.floor(k.current/60)).slice(-2)+":"+("00"+parseInt(k.current%60)).slice(-2);k.timewms=k.readable+"."+("00"+parseInt(100*k.current)).slice(-2);
k.percentage=k.current/b.elAudio.duration*100;e&&"[object Function]"==={}.toString.call(e)&&e(k,c.current,c.changed,h,C);c.changed&&(c.changed=!1);h.loop=!1;h.end=!1;G&&q.getByteFrequencyData(C);window.requestAnimationFrame(d)}var e=a;K||(K=!0,d())};g.prototype.play=function(a,d){a=void 0===a?"":a;d=void 0===d?!1:d;try{""!=a&&(this.elAudio.src=a,this.elAudio.load()),h.play||this.elAudio.play(),h.end&&(h.end=!1,b.elAudio.currentTime=0),d&&(b.isShuffle&&E(),f.shuffleIdx=this.current)}catch(e){throw e;
}return this};g.prototype.isPlaying=function(){return h.play};g.prototype.stop=function(){this.elAudio.currentTime=0;this.elAudio.pause();h.pause=!0;h.end=!0;b.playlist[b.current].lyric.index=0;r.call(this,"time");return this};g.prototype.pause=function(){this.elAudio.pause();h.play=!1;h.pause=!0;r.call(this,"time");return this};g.prototype.seek=function(a){0<this.playlist.length&&(this.elAudio.currentTime=a,r.call(this,"time"));return this};g.prototype.forward=function(a){this.elAudio.currentTime+=
void 0===a?10:a;this.elAudio.onseeked();r.call(this,"time");return this};g.prototype.backward=function(a){this.elAudio.currentTime-=void 0===a?10:a;this.elAudio.onseeked();r.call(this,"time");return this};g.prototype.speed=function(a){this.elAudio.playbackRate=a;this.prop.speed=a;r.call(this,"speed");return this};g.prototype.volume=function(a){this.elAudio.volume=a;this.prop.volume=a;r.call(this,"volume");return this};g.prototype.mute=function(a){this.elAudio.muted=a;this.prop.muted=a;return this};
g.prototype.loop=function(a){this.prop.loop=void 0===a||a?this.repeatState.ALL:this.repeatState.NONE;return this};g.prototype.repeat=function(a){"undefined"==typeof a&&(a=this.prop.loop+1,a%=3);this.prop.loop=a;return this};g.prototype.setVisualiser=function(){G=!0;q=this.context.createAnalyser();I=this.context.createMediaElementSource(this.elAudio);I.connect(q);q.connect(this.context.destination);q.fftSize=256;C=new Uint8Array(q.frequencyBinCount);return this};g.prototype.grab=function(a,d){if(""==
a)return d(!1),0;var e=!0;n.src=a;n.load();n.onloadedmetadata=function(c){if(!e)return!1;d(!0);b.pAdd([this.src],d);e=!1};n.onerror=function(c){e&&d(!1)}};return this};return window.AstLirik=window.astl=function(y,l){l=void 0===l?{}:l;return new g(y,l)}});